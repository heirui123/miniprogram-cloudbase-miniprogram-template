<!-- order-detail/index.wxml -->
<view class="container">
  <!-- 订单状态 -->
  <view class="status-section">
    <view class="status-card">
      <view class="status-icon status-{{order.status === '待接单' ? 'pending' : order.status === '进行中' ? 'in-progress' : order.status === '已完成' ? 'completed' : 'canceled'}}">
        <text class="icon-text">{{order.status === '待接单' ? '⏳' : order.status === '进行中' ? '🔄' : order.status === '已完成' ? '✅' : '❌'}}</text>
      </view>
      <view class="status-info">
        <view class="status-title">{{order.statusText}}</view>
        <view class="status-desc">{{order.statusDesc}}</view>
      </view>
    </view>
    
    <!-- 接自己单的特殊提示 -->
    <view class="own-service-notice" wx:if="{{order.isOwnService}}">
      <view class="notice-icon">💡</view>
      <view class="notice-content">
        <view class="notice-title">您接了自己的服务</view>
        <view class="notice-desc">这是您发布的服务，您自己接单了</view>
      </view>
    </view>
  </view>

  <!-- 服务信息 -->
  <view class="service-info card">
    <view class="section-title">服务信息</view>
    <view class="service-content">
      <image class="service-image" src="{{order.service.images[0] || '/images/default-service.png'}}" mode="aspectFill"></image>
      <view class="service-details">
        <view class="service-title">{{order.service.title}}</view>
        <view class="service-desc">{{order.service.description}}</view>
        <view class="service-price">
          <text class="price-symbol">¥</text>
          <text class="price-value">{{order.price}}</text>
          <text class="price-unit">{{order.priceUnit}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 用户信息 -->
  <view class="user-info card">
    <view class="section-title">用户信息</view>
    <view class="user-content">
      <view class="user-item">
        <view class="user-label">发布者</view>
        <view class="user-detail">
          <image class="user-avatar" src="{{order.publisher.avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"></image>
          <view class="user-info-text">
            <view class="user-name">{{order.publisher.nickName}}</view>
            <view class="user-meta">
              <text class="credit-score">信用评分：{{order.publisher.creditScore || 100}}</text>
              <text class="member-level">{{order.publisher.memberLevel || '普通用户'}}</text>
            </view>
          </view>
        </view>
      </view>
      <view class="user-item" wx:if="{{order.receiver}}">
        <view class="user-label">接单者</view>
        <view class="user-detail">
          <image class="user-avatar" src="{{order.receiver.avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"></image>
          <view class="user-info-text">
            <view class="user-name">{{order.receiver.nickName}}</view>
            <view class="user-meta">
              <text class="credit-score">信用评分：{{order.receiver.creditScore || 100}}</text>
              <text class="member-level">{{order.receiver.memberLevel || '普通用户'}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 订单信息 -->
  <view class="order-info card">
    <view class="section-title">订单信息</view>
    <view class="info-list">
      <view class="info-item">
        <text class="info-label">订单号</text>
        <text class="info-value">{{order._id}}</text>
      </view>
      <view class="info-item">
        <text class="info-label">创建时间</text>
        <text class="info-value">{{order.createTimeText}}</text>
      </view>
      <view class="info-item" wx:if="{{order.updateTimeText !== order.createTimeText}}">
        <text class="info-label">更新时间</text>
        <text class="info-value">{{order.updateTimeText}}</text>
      </view>
      <view class="info-item" wx:if="{{order.paymentTimeText}}">
        <text class="info-label">支付时间</text>
        <text class="info-value">{{order.paymentTimeText}}</text>
      </view>
      <view class="info-item" wx:if="{{order.location.address}}">
        <text class="info-label">服务地址</text>
        <text class="info-value">{{order.location.address}}</text>
      </view>
      <view class="info-item" wx:if="{{order.contactInfo.phone || order.contactInfo.wechat}}">
        <text class="info-label">联系方式</text>
        <text class="info-value">{{order.contactInfo.phone || order.contactInfo.wechat || '暂无'}}</text>
      </view>
      <view class="info-item" wx:if="{{order.requirements}}">
        <text class="info-label">特殊要求</text>
        <text class="info-value">{{order.requirements}}</text>
      </view>
    </view>
  </view>

  <!-- 支付信息 -->
  <view class="payment-info card" wx:if="{{order.paymentStatus}}">
    <view class="section-title">支付信息</view>
    <view class="payment-content">
      <view class="payment-status">
        <text class="payment-label">支付状态</text>
        <text class="payment-value payment-{{order.paymentStatus === '已支付' ? 'success' : 'pending'}}">
          {{order.paymentStatus}}
        </text>
      </view>
      <view class="payment-amount">
        <text class="payment-label">支付金额</text>
        <text class="payment-value">¥{{order.price}}</text>
      </view>
      <view class="payment-time" wx:if="{{order.paymentTimeText}}">
        <text class="payment-label">支付时间</text>
        <text class="payment-value">{{order.paymentTimeText}}</text>
      </view>
    </view>
  </view>

  <!-- 订单时间线 -->
  <view class="timeline-section card">
    <view class="section-title">订单进度</view>
    <view class="timeline">
      <view class="timeline-item {{item.active ? 'active' : ''}}" wx:for="{{timeline}}" wx:key="status">
        <view class="timeline-icon">
          <view class="timeline-dot {{item.active ? 'active' : ''}}"></view>
        </view>
        <view class="timeline-content">
          <view class="timeline-title">{{item.title}}</view>
          <view class="timeline-desc">{{item.desc}}</view>
          <view class="timeline-time">{{item.time}}</view>
        </view>
      </view>
    </view>
  </view>

  <!-- 操作按钮 -->
  <view class="action-buttons">
    <button class="btn btn-outline" bindtap="contactUser">联系用户</button>
    
    <!-- 接单按钮 - 只有接单者可以操作 -->
    <button class="btn btn-primary" 
            wx:if="{{order.status === '待接单' && userInfo && order.receiverId === userInfo.openid}}" 
            bindtap="acceptOrder">
      接单
    </button>
    
    <!-- 完成按钮 - 只有发布者可以操作 -->
    <button class="btn btn-secondary" 
            wx:if="{{order.status === '进行中' && userInfo && order.publisherOpenId === userInfo.openid}}" 
            bindtap="completeOrder">
      完成订单
    </button>
    
    <!-- 支付按钮 - 只有接单者可以支付 -->
    <button class="btn btn-warning" 
            wx:if="{{order.status === '进行中' && order.paymentStatus !== '已支付' && userInfo && order.receiverId === userInfo.openid}}" 
            bindtap="payOrder">
      支付订单
    </button>
    
    <!-- 取消按钮 -->
    <button class="btn btn-danger" 
            wx:if="{{order.status === '待接单' || order.status === '进行中'}}" 
            bindtap="cancelOrder">
      取消订单
    </button>
    
    <!-- 评价按钮 -->
    <button class="btn btn-success" 
            wx:if="{{order.status === '已完成'}}" 
            bindtap="reviewOrder">
      评价订单
    </button>
  </view>

  <!-- 加载状态 -->
  <loading show="{{loading}}" text="加载中..."></loading>
</view> 