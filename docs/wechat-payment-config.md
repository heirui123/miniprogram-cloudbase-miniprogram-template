# 微信支付配置指南

## 📋 配置概述

本文档将指导您完成微信支付的真实环境配置，包括商户号配置、证书上传、域名配置等步骤。

## 🛠️ 配置步骤

### 1. 获取商户号信息

#### 1.1 登录微信商户平台
- 访问：https://pay.weixin.qq.com/
- 使用您的商户号登录

#### 1.2 获取必要信息
在商户平台中获取以下信息：
- **商户号（mchId）**：您的微信支付商户号
- **商户密钥（mchKey）**：API密钥
- **API证书**：下载API证书文件

### 2. 下载API证书

#### 2.1 下载证书文件
1. 登录微信商户平台
2. 进入：账户中心 → API安全 → API证书
3. 下载以下文件：
   - `apiclient_cert.p12` - 证书文件
   - `apiclient_key.pem` - 私钥文件
   - `apiclient_cert.pem` - 证书文件

#### 2.2 证书文件说明
- `apiclient_cert.p12`：用于云开发支付配置
- `apiclient_key.pem`：私钥文件（请妥善保管）
- `apiclient_cert.pem`：证书文件

### 3. 配置云开发支付

#### 3.1 登录云开发控制台
1. 访问：https://console.cloud.tencent.com/tcb
2. 选择环境：`test-env`（cloud1-2g899deedcc43a17）

#### 3.2 配置支付参数
1. 进入：设置 → 环境设置 → 微信支付
2. 填入以下信息：

```json
{
  "mchId": "您的商户号",
  "mchKey": "您的商户密钥",
  "notifyUrl": "https://cloud1-2g899deedcc43a17-1317031037.tcloudbaseapp.com/paymentCallback",
  "certPath": "/path/to/cert/apiclient_cert.p12"
}
```

#### 3.3 上传证书文件
1. 在云开发控制台找到"文件存储"
2. 创建 `cert` 文件夹
3. 上传 `apiclient_cert.p12` 文件到 `cert/` 目录
4. 记录文件路径：`cert/apiclient_cert.p12`

### 4. 配置支付域名

#### 4.1 配置回调域名
在微信商户平台配置支付回调域名：
1. 登录微信商户平台
2. 进入：产品中心 → 开发配置 → 支付回调
3. 添加回调域名：`cloud1-2g899deedcc43a17-1317031037.tcloudbaseapp.com`

#### 4.2 配置H5支付域名（如需要）
如果使用H5支付，还需要配置：
1. 进入：产品中心 → 开发配置 → H5支付
2. 添加支付域名：`cloud1-2g899deedcc43a17-1317031037.tcloudbaseapp.com`

### 5. 小程序配置

#### 5.1 配置小程序支付域名
在微信公众平台配置：
1. 登录微信公众平台
2. 进入：开发 → 开发设置 → 服务器域名
3. 在 `request` 合法域名中添加：
   - `https://cloud1-2g899deedcc43a17-1317031037.tcloudbaseapp.com`

#### 5.2 确认小程序权限
确保小程序已开通以下权限：
- 微信支付
- 用户信息
- 地理位置

### 6. 测试配置

#### 6.1 创建测试订单
使用以下测试数据创建订单：

```javascript
// 测试服务数据
{
  "id": "test_service_001",
  "title": "测试服务",
  "price": 0.01, // 1分钱测试
  "description": "用于支付测试的服务",
  "category": "测试",
  "status": "发布中"
}

// 测试订单数据
{
  "serviceId": "test_service_001",
  "requirements": "支付功能测试",
  "contactInfo": {
    "phone": "13800138000",
    "wechat": "test_user"
  }
}
```

#### 6.2 支付测试流程
1. 打开小程序
2. 进入支付测试页面
3. 创建测试订单
4. 发起支付
5. 验证支付流程

## 🔧 配置验证

### 1. 环境检查
运行以下检查项：

```javascript
// 检查云函数部署状态
// 检查数据库连接
// 检查支付配置
// 检查证书文件
```

### 2. 支付测试
使用测试页面进行完整支付流程测试：

1. **订单创建测试**
   - 验证订单是否成功创建
   - 检查订单数据完整性

2. **支付创建测试**
   - 验证支付订单是否成功创建
   - 检查支付参数正确性

3. **支付流程测试**
   - 验证微信支付界面显示
   - 测试支付完成流程

4. **回调处理测试**
   - 验证支付回调是否正常
   - 检查订单状态更新

## 🚨 常见问题

### 问题1：支付创建失败
**可能原因：**
- 商户号或密钥错误
- 证书文件路径错误
- 回调域名未配置

**解决方案：**
1. 检查商户号和密钥是否正确
2. 确认证书文件已上传且路径正确
3. 验证回调域名配置

### 问题2：支付回调未触发
**可能原因：**
- 回调域名配置错误
- 云函数未正确部署
- 网络连接问题

**解决方案：**
1. 检查回调域名配置
2. 确认云函数部署状态
3. 查看云函数日志

### 问题3：证书文件错误
**可能原因：**
- 证书文件损坏
- 证书文件格式错误
- 证书文件路径错误

**解决方案：**
1. 重新下载证书文件
2. 确认文件格式为.p12
3. 检查文件路径配置

## 📝 安全注意事项

### 1. 证书安全
- 妥善保管证书文件
- 不要将证书文件提交到代码仓库
- 定期更新证书文件

### 2. 密钥安全
- 不要泄露商户密钥
- 定期更换API密钥
- 使用环境变量存储敏感信息

### 3. 域名安全
- 确保回调域名安全
- 使用HTTPS协议
- 定期检查域名配置

## 🔄 配置更新

### 1. 更新商户信息
如需更新商户信息：
1. 在云开发控制台更新配置
2. 重新部署相关云函数
3. 测试支付功能

### 2. 更新证书
如需更新证书：
1. 下载新的证书文件
2. 上传到云存储
3. 更新配置中的证书路径
4. 重新部署云函数

## 📞 技术支持

如果在配置过程中遇到问题，可以：

1. **查看日志**
   - 云函数日志：云开发控制台 → 云函数 → 日志
   - 支付日志：`payment_logs` 集合

2. **联系支持**
   - 微信支付技术支持
   - 云开发技术支持

---

**配置完成时间**：`待完成`
**配置人员**：`待填写`
**审核人员**：`待审核` 