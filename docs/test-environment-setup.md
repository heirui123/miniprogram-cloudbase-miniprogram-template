# 测试环境部署指南

## 📋 概述

本文档提供了在测试环境部署和配置微信支付功能的完整指南，确保支付功能能够正常测试和验证。

## 🛠️ 环境准备

### 1. 云开发环境配置

#### 1.1 创建测试环境
```bash
# 登录云开发控制台
# 创建新的测试环境
# 环境名称: test-env
# 环境ID: test-env-xxxxx
```

#### 1.2 配置云开发环境
在 `miniprogram/app.js` 中配置测试环境：
```javascript
// app.js
wx.cloud.init({
  env: 'test-env-xxxxx', // 替换为实际的测试环境ID
  traceUser: true
})
```

### 2. 微信支付配置

#### 2.1 申请微信支付商户号
1. 登录微信商户平台：https://pay.weixin.qq.com/
2. 申请小程序支付商户号
3. 获取商户号（mchId）和商户密钥（mchKey）

#### 2.2 下载支付证书
1. 在商户平台下载API证书
2. 获取 `cert.pem` 和 `key.pem` 文件
3. 妥善保管证书文件

#### 2.3 配置云开发支付
1. 登录云开发控制台
2. 进入：设置 -> 支付设置
3. 配置以下信息：
   - 商户号：填写申请的商户号
   - 商户密钥：填写商户密钥
   - 证书文件：上传 `cert.pem` 和 `key.pem`
   - 支付回调域名：配置回调域名

## 🚀 部署步骤

### 1. 部署云函数

#### 1.1 部署订单云函数
```bash
# 进入订单云函数目录
cd cloudfunctions/order

# 安装依赖
npm install

# 部署云函数
# 在微信开发者工具中右键点击 order 文件夹
# 选择"上传并部署：云端安装依赖"
```

#### 1.2 部署支付回调云函数
```bash
# 进入支付回调云函数目录
cd cloudfunctions/paymentCallback

# 安装依赖
npm install

# 部署云函数
# 在微信开发者工具中右键点击 paymentCallback 文件夹
# 选择"上传并部署：云端安装依赖"
```

### 2. 配置数据库

#### 2.1 创建数据库集合
在云开发控制台创建以下集合：
- `orders` - 订单集合
- `services` - 服务集合
- `users` - 用户集合
- `notifications` - 通知集合

#### 2.2 设置数据库权限
为每个集合设置适当的权限：
```javascript
// orders 集合权限
{
  "read": true,
  "write": true
}

// services 集合权限
{
  "read": true,
  "write": true
}

// users 集合权限
{
  "read": true,
  "write": true
}

// notifications 集合权限
{
  "read": true,
  "write": true
}
```

### 3. 配置小程序

#### 3.1 配置支付域名
在微信公众平台配置支付域名：
1. 登录微信公众平台
2. 进入：开发 -> 开发设置 -> 服务器域名
3. 添加支付域名到 `request` 合法域名

#### 3.2 配置小程序权限
确保小程序已开通以下权限：
- 微信支付
- 用户信息
- 地理位置

## 🧪 测试数据准备

### 1. 创建测试服务

#### 1.1 手动创建测试服务
在云开发控制台手动创建测试服务：
```javascript
// 在 services 集合中添加测试服务
{
  "_id": "test_service_001",
  "title": "测试服务",
  "description": "用于支付功能测试的服务",
  "price": 1.00,
  "priceUnit": "次",
  "category": "测试",
  "status": "发布中",
  "userOpenId": "test_user_openid",
  "createTime": new Date(),
  "updateTime": new Date()
}
```

#### 1.2 创建测试用户
```javascript
// 在 users 集合中添加测试用户
{
  "_id": "test_user_001",
  "openid": "test_user_openid",
  "nickName": "测试用户",
  "avatarUrl": "https://example.com/avatar.jpg",
  "phone": "13800138000",
  "wechat": "test_wechat",
  "createTime": new Date(),
  "updateTime": new Date()
}
```

### 2. 配置测试工具

#### 2.1 更新测试配置
在 `scripts/test-payment.js` 中更新测试配置：
```javascript
const TEST_CONFIG = {
  // 更新为实际的测试服务ID
  testData: {
    serviceId: 'test_service_001',
    orderData: {
      requirements: '自动化测试订单要求',
      contactInfo: {
        phone: '13800138000',
        wechat: 'auto_test'
      }
    }
  }
}
```

## 🔍 验证步骤

### 1. 环境验证

#### 1.1 检查云函数部署
```bash
# 运行环境检查脚本
node scripts/test-payment.js
```

#### 1.2 检查数据库连接
在云开发控制台验证数据库集合是否正常创建。

#### 1.3 检查支付配置
在云开发控制台验证支付配置是否正确。

### 2. 功能验证

#### 2.1 订单创建测试
1. 打开小程序
2. 进入支付测试页面：`/pages/payment-test/index`
3. 点击"测试订单创建"
4. 验证订单是否成功创建

#### 2.2 支付创建测试
1. 在支付测试页面点击"测试支付创建"
2. 验证支付订单是否成功创建
3. 检查支付参数是否正确

#### 2.3 支付流程测试
1. 点击"发起实际支付"
2. 验证微信支付界面是否正常显示
3. 完成支付流程
4. 检查支付回调是否正常处理

### 3. 异常情况测试

#### 3.1 重复支付测试
1. 对已支付订单再次发起支付
2. 验证是否提示"订单已支付"

#### 3.2 权限验证测试
1. 使用无权限用户操作
2. 验证是否提示"无权限操作"

#### 3.3 无效订单测试
1. 使用无效订单ID
2. 验证是否提示"订单不存在"

## 📊 测试报告

### 1. 生成测试报告
运行完整测试后，系统会自动生成测试报告：
- 测试时间
- 测试结果统计
- 详细测试结果
- 失败原因分析

### 2. 报告内容
测试报告包含以下信息：
- 环境配置检查结果
- 订单创建测试结果
- 支付创建测试结果
- 支付流程测试结果
- 支付回调测试结果
- 异常处理测试结果

## 🚨 常见问题

### 问题 1：云函数部署失败
**解决方案：**
1. 检查云函数代码语法
2. 确认依赖包安装正确
3. 检查云开发环境配置
4. 查看云函数日志

### 问题 2：支付配置错误
**解决方案：**
1. 检查商户号和密钥是否正确
2. 确认证书文件是否上传
3. 验证回调域名配置
4. 检查支付权限是否开通

### 问题 3：数据库权限问题
**解决方案：**
1. 检查数据库集合权限设置
2. 确认用户身份验证
3. 验证数据库连接
4. 查看数据库操作日志

### 问题 4：支付回调未触发
**解决方案：**
1. 检查回调域名配置
2. 确认云函数部署状态
3. 验证回调函数代码
4. 查看云函数日志

## 📝 注意事项

1. **环境隔离**：确保测试环境与生产环境完全隔离
2. **数据安全**：测试数据不应包含敏感信息
3. **证书安全**：妥善保管支付证书文件
4. **日志记录**：详细记录测试过程和结果
5. **回滚准备**：准备数据回滚方案

## 🔧 维护建议

1. **定期测试**：建议每周进行一次完整测试
2. **监控告警**：设置支付相关监控和告警
3. **日志分析**：定期分析云函数日志
4. **性能优化**：根据测试结果优化性能
5. **安全加固**：定期检查安全配置

---

**部署完成时间**：`2025-08-10`
**部署人员**：`AI助手`
**审核人员**：`待审核` 